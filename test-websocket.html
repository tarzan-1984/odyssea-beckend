<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }
        .panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-panel {
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
            max-height: 400px;
            background: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background: white;
            border-left: 3px solid #007bff;
        }
        .message.own {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        .message.system {
            background: #f3e5f5;
            border-left-color: #9c27b0;
            font-style: italic;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input, select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .typing-indicator {
            font-style: italic;
            color: #666;
            margin-bottom: 5px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.info { color: #007bff; }
        .log-entry.success { color: #28a745; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>ðŸš€ WebSocket Chat Test Interface</h1>
    
    <div class="container">
        <!-- Chat Panel -->
        <div class="panel chat-panel">
            <h3>ðŸ’¬ Chat Interface</h3>
            
            <div id="status" class="status disconnected">
                Disconnected
            </div>
            
            <div class="input-group">
                <input type="text" id="jwtToken" placeholder="JWT Token" style="flex: 1;">
                <button onclick="connect()">Connect</button>
                <button onclick="disconnect()">Disconnect</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="chatRoomId" placeholder="Chat Room ID" style="flex: 1;">
                <button onclick="joinRoom()">Join Room</button>
                <button onclick="leaveRoom()">Leave Room</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="roomName" placeholder="Room Name" style="flex: 1;">
                <select id="roomType">
                    <option value="DIRECT">Direct</option>
                    <option value="GROUP">Group</option>
                    <option value="LOAD">Load</option>
                </select>
                <button onclick="createRoom()">Create Room</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="participantIds" placeholder="Participant IDs (comma-separated)" style="flex: 1;">
                <button onclick="addParticipants()">Add Participants</button>
            </div>
            
            <div id="messages" class="messages">
                <div class="message system">Welcome! Connect and join a chat room to start testing.</div>
            </div>
            
            <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>
            
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your message..." style="flex: 1;" onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">Send</button>
            </div>
            
            <div class="input-group">
                <button onclick="startTyping()">Start Typing</button>
                <button onclick="stopTyping()">Stop Typing</button>
                <button onclick="clearMessages()">Clear Messages</button>
            </div>
        </div>
        
        <!-- Log Panel -->
        <div class="panel">
            <h3>ðŸ“‹ Event Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
        </div>
    </div>

    <script>
        let socket = null;
        let currentChatRoomId = null;
        let isTyping = false;
        let typingTimeout = null;

        // Initialize
        document.getElementById('jwtToken').value = localStorage.getItem('jwtToken') || '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
            }
        }

        function addMessage(content, isOwn = false, isSystem = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : ''} ${isSystem ? 'system' : ''}`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connect() {
            const token = document.getElementById('jwtToken').value;
            if (!token) {
                alert('Please enter a JWT token');
                return;
            }

            // Save token to localStorage
            localStorage.setItem('jwtToken', token);

            if (socket) {
                socket.disconnect();
            }

            socket = io('http://localhost:3000/chat', {
                auth: { token },
                transports: ['websocket', 'polling']
            });

            // Connection events
            socket.on('connect', () => {
                log('Connected to WebSocket server', 'success');
                updateStatus(true);
            });

            socket.on('disconnect', () => {
                log('Disconnected from WebSocket server', 'warning');
                updateStatus(false);
            });

            socket.on('connected', (data) => {
                log(`Authenticated as user ${data.userId} (${data.userRole})`, 'success');
                addMessage(`Connected as ${data.userId}`, false, true);
            });

            // Chat room events
            socket.on('joinedChatRoom', (data) => {
                log(`Joined chat room: ${data.chatRoomId}`, 'success');
                addMessage(`Joined room ${data.chatRoomId}`, false, true);
                currentChatRoomId = data.chatRoomId;
            });

            socket.on('leftChatRoom', (data) => {
                log(`Left chat room: ${data.chatRoomId}`, 'info');
                addMessage(`Left room ${data.chatRoomId}`, false, true);
                if (currentChatRoomId === data.chatRoomId) {
                    currentChatRoomId = null;
                }
            });

            socket.on('chatRoomCreated', (data) => {
                log(`Created chat room: ${data.id} (${data.name})`, 'success');
                addMessage(`Created room: ${data.name}`, false, true);
            });

            socket.on('chatRoomUpdated', (data) => {
                log(`Chat room updated: ${data.chatRoomId}`, 'info');
                addMessage(`Room ${data.chatRoomId} updated`, false, true);
            });

            socket.on('participantsAdded', (data) => {
                log(`Added participants to room: ${data.chatRoomId}`, 'success');
                addMessage(`Added participants to room ${data.chatRoomId}`, false, true);
            });

            socket.on('participantRemoved', (data) => {
                log(`Removed participant from room: ${data.chatRoomId}`, 'info');
                addMessage(`Removed participant from room ${data.chatRoomId}`, false, true);
            });

            // Message events
            socket.on('newMessage', (data) => {
                log(`New message in room ${data.chatRoomId}: ${data.message.content}`, 'info');
                addMessage(`${data.message.sender.firstName}: ${data.message.content}`);
            });

            socket.on('messageSent', (data) => {
                log(`Message sent: ${data.messageId}`, 'success');
            });

            socket.on('messageRead', (data) => {
                log(`Message read: ${data.messageId}`, 'info');
            });

            // Typing events
            socket.on('userTyping', (data) => {
                const typingDiv = document.getElementById('typingIndicator');
                if (data.isTyping) {
                    typingDiv.textContent = `User ${data.userId} is typing...`;
                    typingDiv.style.display = 'block';
                } else {
                    typingDiv.style.display = 'none';
                }
            });

            // User presence events
            socket.on('userJoined', (data) => {
                log(`User ${data.userId} joined room ${data.chatRoomId}`, 'info');
                addMessage(`User ${data.userId} joined`, false, true);
            });

            socket.on('userLeft', (data) => {
                log(`User ${data.userId} left room ${data.chatRoomId}`, 'info');
                addMessage(`User ${data.userId} left`, false, true);
            });

            // Error handling
            socket.on('error', (error) => {
                log(`Error: ${error.message}`, 'error');
                addMessage(`Error: ${error.message}`, false, true);
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus(false);
                log('Manually disconnected', 'warning');
            }
        }

        function joinRoom() {
            const chatRoomId = document.getElementById('chatRoomId').value;
            if (!chatRoomId) {
                alert('Please enter a chat room ID');
                return;
            }
            if (!socket) {
                alert('Please connect first');
                return;
            }
            socket.emit('joinChatRoom', { chatRoomId });
            log(`Attempting to join room: ${chatRoomId}`, 'info');
        }

        function leaveRoom() {
            if (!currentChatRoomId) {
                alert('Not in any room');
                return;
            }
            socket.emit('leaveChatRoom', { chatRoomId: currentChatRoomId });
            log(`Leaving room: ${currentChatRoomId}`, 'info');
        }

        function createRoom() {
            const name = document.getElementById('roomName').value;
            const type = document.getElementById('roomType').value;
            const participantIds = document.getElementById('participantIds').value
                .split(',')
                .map(id => id.trim())
                .filter(id => id);

            if (!socket) {
                alert('Please connect first');
                return;
            }

            socket.emit('createChatRoom', {
                name: name || undefined,
                type,
                participantIds
            });
            log(`Creating room: ${name || 'Unnamed'} (${type})`, 'info');
        }

        function addParticipants() {
            const participantIds = document.getElementById('participantIds').value
                .split(',')
                .map(id => id.trim())
                .filter(id => id);

            if (!currentChatRoomId) {
                alert('Please join a room first');
                return;
            }
            if (participantIds.length === 0) {
                alert('Please enter participant IDs');
                return;
            }

            socket.emit('addParticipants', {
                chatRoomId: currentChatRoomId,
                participantIds
            });
            log(`Adding participants to room ${currentChatRoomId}: ${participantIds.join(', ')}`, 'info');
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            if (!currentChatRoomId) {
                alert('Please join a room first');
                return;
            }

            socket.emit('sendMessage', {
                chatRoomId: currentChatRoomId,
                content
            });
            
            addMessage(content, true);
            messageInput.value = '';
            log(`Sending message: ${content}`, 'info');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function startTyping() {
            if (!currentChatRoomId) {
                alert('Please join a room first');
                return;
            }
            if (!isTyping) {
                socket.emit('typing', {
                    chatRoomId: currentChatRoomId,
                    isTyping: true
                });
                isTyping = true;
                log('Started typing', 'info');
            }
        }

        function stopTyping() {
            if (!currentChatRoomId) return;
            if (isTyping) {
                socket.emit('typing', {
                    chatRoomId: currentChatRoomId,
                    isTyping: false
                });
                isTyping = false;
                log('Stopped typing', 'info');
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            log('Messages cleared', 'info');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Auto-connect if token exists
        window.onload = function() {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                document.getElementById('jwtToken').value = token;
                log('Token found, ready to connect', 'info');
            }
        };
    </script>
</body>
</html>
